<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Penilaian Risiko Deforestasi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>


  <!-- GestureHandling Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css">
  <script src="https://unpkg.com/leaflet-gesture-handling"></script>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <style>
    body { background:#fff; color:#000; font-family:'Roboto Mono', monospace; overflow:hidden; margin:0; }
    .card { background:#f8f9fa; border-radius:10px; padding:10px; color:#000; }
    .reset-btn { background:#e74c3c; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:.9rem; }
    #map { height:100%; border-radius:8px; min-height:300px; }
    .logo { height:30px; }
    .header-container { display:grid; grid-template-columns:1fr auto; align-items:center; }
    .logo-container{justify-self:start;} .reset-container{justify-self:end;}
    canvas{max-height:160px!important;} .card h5{font-size:.9rem;} .card p{font-size:.8rem;margin-bottom:.3rem;}
    .small-card{flex:0 0 auto;min-height:80px;} #map-card{flex:1 1 0;min-height:0;} #pie-card{flex:1 1 0;min-height:200px;padding:10px;}
    #riskPie{height:100%!important;}
    .back-btn {
      background-color: #f8f9fa;
      color: #000;
      border: 1px solid rgba(0,0,0,0.125);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      text-decoration: none;
    }
    .back-btn:hover { background-color: #e9ecef; color: #000; }

    @media (max-width:767px){
      body{overflow:auto;}
      #map{height:50vh!important;}
      #pie-card{height:200px;}

      html, body { overflow-x: hidden; max-width: 100%; }
      .container-fluid, .row { margin-left: 0; margin-right: 0; }

      .footer-note p { text-align: left !important; }
      .footer-note .btn.back-btn { display: block; margin: 0.5rem auto 0 auto; }
    }

    @media (min-width:768px){
      html,body{height:100%;}
      .container-fluid{height:100%;display:flex;flex-direction:column;}
      .dashboard-wrapper{flex:1;display:flex;flex-direction:column;padding:8px;box-sizing:border-box;min-height:0;
        border:1px solid rgba(0,0,0,.125);border-radius:10px;background-color:transparent;}
      .footer-note{flex-shrink:0;}
      .row.g-2{flex:1;min-height:0;display:flex;flex-wrap:nowrap;}
      .col-md-3{flex:0 0 25%;display:flex;flex-direction:column;min-height:0;gap:.5rem;}
      .col-md-3 .small-card{flex:0 0 auto;} #map-card{flex:1 1 0;min-height:0;}
      .col-md-6{flex:0 0 50%;display:flex;flex-direction:column;min-height:0;overflow-y:auto;gap:.5rem;padding-bottom:.5rem;}
      .col-md-3:last-child{flex:0 0 25%;display:flex;flex-direction:column;min-height:0;gap:.5rem;}
      .col-md-3:last-child .card{flex:1 1 0;min-height:0;}

      .info-card p, .cover-card p, .disturb-card p { font-size: 0.75rem; line-height: 1.2; }
    }
  </style>
</head>
<body class="p-2">
  <div class="container-fluid">
    <!-- header -->
    <div class="header-container mb-2">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/asiamakmurdata/laporan-sementara/main/img/logoss.svg" alt="Logo" class="logo">
      </div>
      <div class="reset-container">
        <button id="resetBtn" class="reset-btn">Reset</button>
      </div>
    </div>

    <!-- wrapper -->
    <div class="dashboard-wrapper">
      <div class="row g-2 h-100">
        <!-- Kolom 1 -->
        <div class="col-md-3">
          <div class="card small-card">
            <h5>Group</h5>
            <select id="groupSelect">
  <option value="">Pilih Grup</option>
</select>



          </div>
          <div class="card small-card">
            <h5>ID Kebun</h5>
         <select id="plotSelect">
  <option value="">Pilih ID Kebun</option>
</select>
          </div>
          <div id="map-card" class="card d-flex flex-column">
            <h5>Lokasi Plot</h5>
            <div id="map" class="flex-fill"></div>
          </div>
        </div>

        <!-- Kolom 2 -->
        <div class="col-md-6">
          <div class="card flex-fill"><h5>Disturbances by GFC</h5><canvas id="chartGFC"></canvas></div>
          <div class="card flex-fill"><h5>Disturbances by TMF</h5><canvas id="chartTMF"></canvas></div>
          <div class="card flex-fill"><h5>Disturbances by RADD</h5><canvas id="chartRADD"></canvas></div>
          <div class="card flex-fill"><h5>Fires by MODIS</h5><canvas id="chartMODIS"></canvas></div>
        </div>

        <!-- Kolom 3 -->
        <div class="col-md-3">
          <div class="card flex-fill info-card">
            <h5>Informasi Plot</h5>
            <p id="info-id">ID Kebun: </p>
            <p id="info-nama">Nama: </p>
            <p id="info-luas">Luas: </p>
            <p id="info-koordinat">Koordinat: </p>
          </div>

          <div class="card flex-fill cover-card">
            <h5>Indikator Tutupan</h5>
            <p>Tutupan Pohon &gt;10%:</p>
            <p>Tutupan Hutan 2020:</p>
            <p>Komoditas Kopi 2023:</p>
          </div>

          <div class="card flex-fill disturb-card">
            <h5>Gangguan Hutan</h5>
            <p>&le; 2020:</p>
            <p>&gt; 2020:</p>
          </div>

          <div id="pie-card" class="card d-flex flex-column">
            <h5>Penilaian Risiko</h5>
            <canvas id="riskPie" class="flex-fill"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- footer -->
    <div class="row mt-2 footer-note">
      <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
          <p class="mb-2 mb-md-0 text-md-start" style="font-size:0.8em; line-height:1.4;">
            Catatan: Penilaian risiko deforestasi menggunakan tools WHISP-OpenForis (data masih dalam pemrosesan)
          </p>
          <div class="text-center text-md-end">
            <a href="https://asiamakmurdata.github.io/laporan-sementara/#Penilaian" 
               class="btn back-btn">Kembali</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const map = L.map('map', { gestureHandling: true }).setView([-2.5,118],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
    let marker=null;

function makeChart(ctx, label) {
  const labels = [
    '2000','2001','2002','2003','2004','2005','2006','2007',
    '2008','2009','2010','2011','2013','2014','2015','2016',
    '2017','2018','2019','2020','2021','2022','2023','2024','2025'
  ];

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label,
        data: Array(labels.length).fill(0),
        backgroundColor: '#007bff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          ticks: {
             autoSkip: false, // <--- tambahkan ini
            callback: function(value, index) {
              const tahun = labels[index];
              return ['2005','2010','2015','2020'].includes(tahun) ? tahun : '';
            },
            font: { family: 'Roboto Mono', size: 10 },
            maxRotation: 0,
            minRotation: 0
          }
        },
        y: {
          title: {
            display: true,
            text: '# Plot',
            font: { family: 'Roboto Mono', size: 12 }
          },
          ticks: { font: { family: 'Roboto Mono', size: 10 } }
        }
      }
    }
  });
}



    makeChart(document.getElementById('chartGFC'),'GFC');
    makeChart(document.getElementById('chartTMF'),'TMF');
    makeChart(document.getElementById('chartRADD'),'RADD');
    makeChart(document.getElementById('chartMODIS'),'MODIS');

    let isMobile = window.innerWidth < 768;
    let labelButuh = isMobile ? "Butuh Informasi Lanjutan" : ["Butuh","Informasi","Lanjutan"];
    let legendPosition = isMobile ? "bottom" : "left";

    const pieChart=new Chart(document.getElementById('riskPie'),{
      type:'pie',
      data:{labels:['Rendah','Tinggi',labelButuh],
        datasets:[{data:[76,1,23],backgroundColor:['#007bff','#dc3545','darkgray']}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:legendPosition,labels:{font:{size:10,family:'Roboto Mono'}}},
          datalabels:{color:'#fff',font:{size:10,family:'Roboto Mono'}}}},
      plugins:[ChartDataLabels]
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      map.setView([-2.5,118],5); if(marker){map.removeLayer(marker); marker=null;}
      pieChart.data.datasets[0].data=[30,45,25]; pieChart.update();
      document.getElementById('groupSelect').value="all";
      document.getElementById('plotSelect').value="all";
      document.getElementById("info-id").textContent="ID Kebun:";
      document.getElementById("info-nama").textContent="Nama:";
      document.getElementById("info-luas").textContent="Luas:";
      document.getElementById("info-koordinat").textContent="Koordinat:";
    });

  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTK9cOmEW7afpd6n-UkxA8yVNyH2sYgpWTtt_s-pObhJM2xzohroV7rnSCJW4yEyzKzlXzOCI_4pEIT/pub?gid=0&single=true&output=csv";

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      console.log("Data Sheet Loaded:", results.data);
      initFromData(results.data);
    },
    error: function(err, file, inputElem, reason) {
      console.error("Failed to load CSV:", reason);
    }
  });

function initFromData(data) {
  const groupSelect = document.getElementById("groupSelect");
  const plotSelect = document.getElementById("plotSelect");

  // isi dropdown Group
  groupSelect.innerHTML = '<option value="all">All</option>';
  const groups = [...new Set(data.map(r => r.Group))];
  groups.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    groupSelect.appendChild(opt);
  });

  // isi dropdown ID Kebun awal
  updatePlotDropdown(data);

  // === event listener Group ===
  groupSelect.addEventListener("change", () => {
    const selectedGroup = groupSelect.value;
    let filtered = data;

    if (selectedGroup !== "all") {
      filtered = data.filter(r => r.Group === selectedGroup);
    }

    // update dropdown ID Kebun
    updatePlotDropdown(filtered);

    // update card info jumlah plot
    document.getElementById("info-id").textContent = "Jumlah Plot: " + filtered.length;
    document.getElementById("info-nama").textContent = "Nama:";
    document.getElementById("info-luas").textContent = "Luas:";
    document.getElementById("info-koordinat").textContent = "Koordinat:";

    // reset marker kalau ganti group
    if (marker) { map.removeLayer(marker); marker = null; }
    map.setView([-2.5, 118], 5); // kembali ke posisi default
  });

  // === event listener ID Kebun ===
  plotSelect.addEventListener("change", () => {
    const selectedID = plotSelect.value;
    if (selectedID !== "all") {
      const info = data.find(r => r.ID_Kebun === selectedID);
      if (info) {
        document.getElementById("info-id").textContent = "ID Kebun: " + info.ID_Kebun;
        document.getElementById("info-nama").textContent = "Nama: " + info.Nama;
        document.getElementById("info-luas").textContent = "Luas: " + info.Luas_Kebun;
        document.getElementById("info-koordinat").textContent = `Koordinat: ${info.Latitude}, ${info.Longitude}`;

        // update marker di peta
        if (marker) map.removeLayer(marker);
        marker = L.marker([info.Latitude, info.Longitude]).addTo(map);
        map.setView([info.Latitude, info.Longitude], 13);
      }
    }
  });
}

function updatePlotDropdown(filtered) {
  const plotSelect = document.getElementById("plotSelect");
  plotSelect.innerHTML = '<option value="all">All</option>';

  filtered.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.ID_Kebun;
    opt.textContent = r.ID_Kebun;
    plotSelect.appendChild(opt);
  });
}


</script>

</body>
</html>