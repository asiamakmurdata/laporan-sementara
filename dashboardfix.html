<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Penilaian Risiko Deforestasi - Fix Informasi Plot</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css">
  <script src="https://unpkg.com/leaflet-gesture-handling"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

  <style>
    body { background:#fff; color:#000; font-family:'Roboto Mono', monospace; overflow:hidden; margin:0; }
    .card { background:#f8f9fa; border-radius:10px; padding:10px; color:#000; }
    .reset-btn { background:#e74c3c; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:.9rem; }
    #map { height:100%; border-radius:8px; min-height:300px; }
    .logo { height:30px; }
    .header-container { display:grid; grid-template-columns:1fr auto; align-items:center; }
    .logo-container{justify-self:start;} .reset-container{justify-self:end;}
    canvas{max-height:160px!important;} .card h5{font-size:.9rem;} .card p{font-size:.8rem;margin-bottom:.3rem;}
    .small-card{flex:0 0 auto;min-height:80px;} #map-card{flex:1 1 0;min-height:0;} #pie-card{flex:1 1 0;min-height:200px;padding:10px;}
    #riskPie{height:100%!important;}
    .back-btn { background-color: #f8f9fa; color: #000; border: 1px solid rgba(0,0,0,0.125); padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; text-decoration: none; }
    .back-btn:hover { background-color: #e9ecef; color: #000; }
    @media (max-width:767px){
      body{overflow:auto;}
      #map{height:50vh!important;}
      #pie-card{height:200px;}
      html, body { overflow-x: hidden; max-width: 100%; }
      .container-fluid, .row { margin-left: 0; margin-right: 0; }
      .footer-note p { text-align: left !important; }
      .footer-note .btn.back-btn { display: block; margin: 0.5rem auto 0 auto; }
    }
    @media (min-width:768px){
      html,body{height:100%;}
      .container-fluid{height:100%;display:flex;flex-direction:column;}
      .dashboard-wrapper{flex:1;display:flex;flex-direction:column;padding:8px;box-sizing:border-box;min-height:0;
        border:1px solid rgba(0,0,0,.125);border-radius:10px;background-color:transparent;}
      .footer-note{flex-shrink:0;}
      .row.g-2{flex:1;min-height:0;display:flex;flex-wrap:nowrap;}
      .col-md-3{flex:0 0 25%;display:flex;flex-direction:column;min-height:0;gap:.5rem;}
      .col-md-6{flex:0 0 50%;display:flex;flex-direction:column;min-height:0;overflow-y:auto;gap:.5rem;padding-bottom:.5rem;}
      .col-md-3:last-child{flex:0 0 25%;display:flex;flex-direction:column;min-height:0;gap:.5rem;}
      .col-md-3:last-child .card{flex:1 1 0;min-height:0;}
      .info-card p, .cover-card p, .disturb-card p { font-size: 0.75rem; line-height: 1.2; }
    }
  </style>
</head>
<body class="p-2">
  <div class="container-fluid">
    <div class="header-container mb-2">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/asiamakmurdata/laporan-sementara/main/img/logoss.svg" alt="Logo" class="logo">
      </div>
      <div class="reset-container">
        <button id="resetBtn" class="reset-btn">Reset</button>
      </div>
    </div>

    <div class="dashboard-wrapper">
      <div class="row g-2 h-100">
        <!-- Kolom 1 -->
        <div class="col-md-3">
          <div class="card small-card">
            <h5>Group</h5>
            <select id="groupSelect">
              <option value="all">All</option>
            </select>
          </div>
          <div class="card small-card">
            <h5>ID Kebun</h5>
            <select id="plotSelect">
              <option value="all">All</option>
            </select>
          </div>
          <div id="map-card" class="card d-flex flex-column">
            <h5>Lokasi Plot</h5>
            <div id="map" class="flex-fill"></div>
          </div>
        </div>

        <!-- Kolom 2 -->
        <div class="col-md-6">
          <div class="card flex-fill"><h5>Disturbances by GFC</h5><canvas id="chartGFC"></canvas></div>
          <div class="card flex-fill"><h5>Disturbances by TMF</h5><canvas id="chartTMF"></canvas></div>
          <div class="card flex-fill"><h5>Disturbances by RADD</h5><canvas id="chartRADD"></canvas></div>
          <div class="card flex-fill"><h5>Fires by MODIS</h5><canvas id="chartMODIS"></canvas></div>
        </div>

        <!-- Kolom 3 -->
        <div class="col-md-3">
          <div class="card flex-fill info-card">
            <h5>Informasi Plot</h5>
            <p id="info-id">Jumlah Plot: </p>
            <p id="info-nama">Nama: </p>
            <p id="info-luas">Luas: </p>
            <p id="info-koordinat">Koordinat: </p>
          </div>

          <div class="card flex-fill cover-card">
            <h5>Indikator Tutupan</h5>
            <p>Tutupan Pohon &gt;10%:</p>
            <p>Tutupan Hutan 2020:</p>
            <p>Komoditas Kopi 2023:</p>
          </div>

          <div class="card flex-fill disturb-card">
            <h5>Gangguan Hutan</h5>
            <p>&le; 2020:</p>
            <p>&gt; 2020:</p>
          </div>

          <div id="pie-card" class="card d-flex flex-column">
            <h5>Penilaian Risiko</h5>
            <canvas id="riskPie" class="flex-fill"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- footer -->
    <div class="row mt-2 footer-note">
      <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
          <p class="mb-2 mb-md-0 text-md-start" style="font-size:0.8em; line-height:1.4;">
            Catatan: Penilaian risiko deforestasi menggunakan tools WHISP-OpenForis
          </p>
          <div class="text-center text-md-end">
            <a href="https://asiamakmurdata.github.io/laporan-sementara/#Penilaian" class="btn back-btn">Kembali</a>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* MAP */
const map = L.map('map', { gestureHandling: true }).setView([-5.5, 105.3],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
let marker = null;

/* CHART MAKER */
function makeChart(ctx, label, showSpecialTicks=false) {
  return new Chart(ctx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label, data: [], backgroundColor: [] }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: {
        label: (ctx) => ` ${ctx.dataset.label} ${ctx.label}: ${ctx.raw} plot`
      }}},
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            font: { family: 'Roboto Mono', size: 10 },
            maxRotation: 0,
            minRotation: 0,
            callback: function(value, index) {
              const year = this.getLabelForValue(value);
              if (showSpecialTicks) {
                return [2005,2010,2015,2020].includes(parseInt(year)) ? year : '';
              }
              return year;
            }
          }
        },
        y: {
          title: { display: true, text: '# Plot', font: { family: 'Roboto Mono', size: 12 } },
          ticks: { font: { family: 'Roboto Mono', size: 10 }, precision:0, beginAtZero:true }
        }
      }
    }
  });
}

const chartGFC  = makeChart(document.getElementById('chartGFC'),'GFC',true);
const chartTMF  = makeChart(document.getElementById('chartTMF'),'TMF',true);
const chartRADD = makeChart(document.getElementById('chartRADD'),'RADD',false);
const chartMODIS= makeChart(document.getElementById('chartMODIS'),'MODIS',true);

/* UTILS */
function toNum(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).trim().replace(',', '.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function getField(row, keys) {
  for (const k of keys) {
    if (row.hasOwnProperty(k) && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== '') return row[k];
  }
  return '';
}

/* UPDATE INFO PLOT (robust to column name variations) */
function updateInfoPlot(filtered, selectedGroup, selectedPlot) {
  // jumlah plot selalu tampil
  const cnt = filtered ? filtered.length : 0;
  document.getElementById("info-id").textContent = "Jumlah Plot: " + cnt;
  

  if (selectedPlot !== "all" && filtered.length === 1) {
    const r = filtered[0];
    const id = getField(r, ['ID_Kebun']);
    const name = getField(r, ['Nama']);
    const luas = getField(r, ['Luas_Kebun']);
    const lat = toNum(getField(r, ['Latitude']));
    const lng = toNum(getField(r, ['Longitude']));

    document.getElementById("info-nama").textContent = "Nama: " + (name || '');
    document.getElementById("info-luas").textContent = "Luas: " + (luas ? Number(luas).toLocaleString() + " ha" : "");
    document.getElementById("info-koordinat").textContent = `Koordinat: ${lat}, ${lng}`;

    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map)
               .bindPopup(`<b>${name||''}</b><br/>ID: ${id||''}`).openPopup();
    map.setView([lat, lng], 12);

  } else if (selectedGroup !== "all" && filtered.length > 0) {
    const totalLuas = filtered.reduce((s,r) => s + toNum(getField(r, ['Luas_Kebun','LUAS_HA','Luas','luas'])), 0);
    const avgLat = filtered.reduce((s,r) => s + toNum(getField(r, ['Latitude','LATITUDE','latitude'])), 0) / filtered.length;
    const avgLng = filtered.reduce((s,r) => s + toNum(getField(r, ['Longitude','LONGITUDE','longitude'])), 0) / filtered.length;

    document.getElementById("info-nama").textContent = "Nama: " + selectedGroup;
    document.getElementById("info-luas").textContent = "Luas: " + totalLuas.toLocaleString() + " ha";
    document.getElementById("info-koordinat").textContent = `Koordinat: ${avgLat.toFixed(5)}, ${avgLng.toFixed(5)}`;

    if (marker) map.removeLayer(marker);
    marker = L.marker([avgLat, avgLng]).addTo(map)
               .bindPopup(`<b>${selectedGroup}</b><br/>Plots: ${filtered.length}`);
    map.setView([avgLat, avgLng], 8);

  } else {
    // All / default
    document.getElementById("info-nama").textContent = "Nama:";
    document.getElementById("info-luas").textContent = "Luas:";
    document.getElementById("info-koordinat").textContent = "Koordinat:";
    if (marker) { map.removeLayer(marker); marker=null; }
    map.setView([-5.5,105.3],5);
  }
}

/* UPDATE CHART BY REGEX (sama seperti sebelumnya) */
function updateChartByRegex(filtered, chart, regex, baseYear) {
  const allKeys = new Set();
  filtered.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));

  const idxMap = {};
  for (const key of allKeys) {
    const m = key.match(regex);
    if (m) {
      let idxStr = (m[1] || '').trim();
      if (idxStr === '') continue;
      const idx = parseInt(idxStr, 10);
      if (!Number.isFinite(idx)) continue;
      if (!idxMap[idx]) idxMap[idx] = [];
      idxMap[idx].push(key);
    }
  }

  const indices = Object.keys(idxMap).map(Number).sort((a,b)=>a-b);
  const counts = indices.map(()=>0);
  filtered.forEach(row => {
    indices.forEach((idx, j) => {
      const keys = idxMap[idx];
      let positive = false;
      for (const k of keys) {
        if (toNum(row[k]) > 0) { positive = true; break; }
      }
      if (positive) counts[j] += 1;
    });
  });

  const labels = indices.map(idx => baseYear + (idx - 1));
  const colors = labels.map(y => y > 2020 ? '#dc3545' : '#007bff');

  chart.data.labels = labels;
  chart.data.datasets[0].data = counts;
  chart.data.datasets[0].backgroundColor = colors;
  chart.update();
}

/* PIE CHART */
let isMobile = window.innerWidth < 768;
let labelButuh = isMobile ? "Butuh Informasi Lanjutan" : ["Butuh","Informasi","Lanjutan"];
let legendPosition = isMobile ? "bottom" : "left";

const pieChart=new Chart(document.getElementById('riskPie'),{
  type:'pie',
  data:{labels:['Rendah','Tinggi',labelButuh],datasets:[{data:[0,0,0],backgroundColor:['#007bff','#dc3545','darkgray']}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:legendPosition,labels:{font:{size:10,family:'Roboto Mono'}}},datalabels:{color:'#fff',font:{size:10,family:'Roboto Mono'}}}},
  plugins:[ChartDataLabels]
});

function updatePieChart(data) {
  const counts = { Rendah: 0, Tinggi: 0, "Butuh Informasi Lanjutan": 0 };
  data.forEach(r => { if (counts[r["Penilaian_Risiko"]] !== undefined) counts[r["Penilaian_Risiko"]]++; });
  pieChart.data.datasets[0].data = [counts["Rendah"], counts["Tinggi"], counts["Butuh Informasi Lanjutan"]];
  pieChart.update();
}

/* UPDATE INDICATORS (robust summing) */
function updateIndicators(filtered) {
  const sum = (arr, col) => arr.reduce((s, r) => s + toNum(r[col]), 0);
  const totalTutupanPohon = sum(filtered,"GFC_TC_202");
  const totalHutan2020    = sum(filtered,"EUFO_2020");
  const totalKomoditas    = sum(filtered,"Oil_palm_D") + sum(filtered,"Oil_palm_F") + sum(filtered,"Coffee_FDa") + sum(filtered,"Cocoa_FDaP") + sum(filtered,"Cocoa_ETH") + sum(filtered,"Rubber_FDa") + sum(filtered,"Rubber_RBG") +
    sum(filtered,"Oil_palm_2") + sum(filtered,"Rubber_202") + sum(filtered,"Coffee_F_1") + sum(filtered,"Cocoa_2023");

  const totalBefore2020   = sum(filtered,"TMF_deg_be") + sum(filtered,"TMF_def_be") + sum(filtered,"GFC_loss_b") + sum(filtered,"ESA_fire_b") + sum(filtered,"MODIS_fi26") + sum(filtered,"RADD_befor");
  const totalAfter2020    = sum(filtered,"TMF_deg_af") + sum(filtered,"TMF_def_af") + sum(filtered,"GFC_loss_a") + sum(filtered,"MODIS_fi27") + sum(filtered,"RADD_after");

  document.querySelector(".cover-card").innerHTML = `
    <h5>Indikator Tutupan</h5>
    <p>Tutupan Pohon >10%: ${totalTutupanPohon.toLocaleString()} ha</p>
    <p>Tutupan Hutan 2020: ${totalHutan2020.toLocaleString()} ha</p>
    <p>Komoditas: ${totalKomoditas.toLocaleString()} ha</p>
  `;

  document.querySelector(".disturb-card").innerHTML = `
    <h5>Gangguan Hutan</h5>
    <p>â‰¤ 2020: ${totalBefore2020.toLocaleString()} ha</p>
    <p>> 2020: ${totalAfter2020.toLocaleString()} ha</p>
  `;
}

/* RESET: set selects to all and fire change so handlers update everything */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('groupSelect').value = 'all';
  document.getElementById('plotSelect').value = 'all';
  // trigger change event to re-run filters & charts
  document.getElementById('groupSelect').dispatchEvent(new Event('change'));
});

/* LOAD CSV */
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTK9cOmEW7afpd6n-UkxA8yVNyH2sYgpWTtt_s-pObhJM2xzohroV7rnSCJW4yEyzKzlXzOCI_4pEIT/pub?gid=0&single=true&output=csv";

Papa.parse(csvUrl, { download: true, header: true, complete: function(results) { initDashboard(results.data); } });

function initDashboard(data) {
  const groupSelect = document.getElementById("groupSelect");
  const plotSelect  = document.getElementById("plotSelect");

  // isi dropdown Group (tambah "all" sudah ada di HTML)
  const groups = [...new Set(data.map(r => r.Group))].filter(Boolean);
  groups.forEach(g => { const opt = document.createElement("option"); opt.value = g; opt.textContent = g; groupSelect.appendChild(opt); });

  function updatePlotDropdown(filtered) {
    plotSelect.innerHTML = '<option value="all">All</option>';
    filtered.forEach(r => {
      const id = getField(r, ['ID_Kebun','ID_KEBUN','id_kebun','ID']);
      const opt = document.createElement("option");
      opt.value = id || '';
      opt.textContent = id || '';
      plotSelect.appendChild(opt);
    });
  }

  function refreshCharts(filtered) {
    updatePieChart(filtered);
    updateChartByRegex(filtered, chartGFC,  /^GFC\s*_?loss_?(\d{1,2})\s*$/i, 2001);
    updateChartByRegex(filtered, chartTMF,  /^TMF\s*_?def_?(\d{1,2})\s*$/i, 2000);
    updateChartByRegex(filtered, chartRADD, /^RADD\s*_?yea_?(\d{1,2})\s*$/i, 2019);
    updateChartByRegex(filtered, chartMODIS,/^MODIS\s*fi_?(\d{1,2})$/i,2000);
  }

  groupSelect.addEventListener("change", () => {
    const selectedGroup = groupSelect.value || "all";
    let filtered = data;
    if (selectedGroup !== "all") filtered = data.filter(r => r.Group === selectedGroup);
    updatePlotDropdown(filtered);
    updateInfoPlot(filtered, selectedGroup, "all");
    refreshCharts(filtered);
    updateIndicators(filtered);
  });

  plotSelect.addEventListener("change", () => {
    const selectedGroup = groupSelect.value || "all";
    const selectedPlot = plotSelect.value || "all";
    let filtered = data;
    if (selectedGroup !== "all") filtered = filtered.filter(r => r.Group === selectedGroup);
    if (selectedPlot !== "all") filtered = filtered.filter(r => {
      const id = getField(r, ['ID_Kebun','ID_KEBUN','id_kebun','ID']);
      return id == selectedPlot;
    });
    updateInfoPlot(filtered, selectedGroup, selectedPlot);
    refreshCharts(filtered);
    updateIndicators(filtered);
  });

  // initial
  updatePieChart(data);
  refreshCharts(data);
  updateIndicators(data);
}
</script>
</body>
</html>
