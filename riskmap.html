<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css"/>
<title>Risk Map - Split Risiko</title>
<style>
.legend-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}
.legend-content { margin-top: 6px; }
.legend.collapsed .legend-content { display: none; }
body { font-family: "Roboto Mono", monospace; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
#map { flex: 1; width: 100%; }
.legend { position: absolute; bottom: 20px; left: 10px; background: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; min-width: 220px; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-family: "Roboto Mono", monospace; }
.legend-title { font-weight: bold; margin-bottom: 6px; font-size: 13px; }
.legend-subtitle { font-weight: bold; font-size: 12px; margin-bottom: 4px; }
.legend-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 13px; }
.legend-color { width: 14px; height: 14px; margin-right: 8px; border: 1px solid #555; border-radius: 2px; }
.legend-color.circle { border-radius: 50%; }
.legend-text { flex: 1; line-height: 1.2em; }
.leaflet-control-layers { font-family: "Roboto Mono", monospace; font-size: 12px; }
.leaflet-control-layers-overlays label { display: flex; align-items: flex-start; white-space: normal; line-height: 1.2em; }
.leaflet-control-layers-overlays input[type="checkbox"] { margin-top: 2px; }
.leaflet-control-layers-overlays .layer-text { margin-left: 6px; }
.leaflet-control-layers-label { font-weight: bold; margin: 6px 0 4px; }
hr.layer-separator { border: none; border-top: 1px solid #ccc; margin: 6px 0; }
@media (max-width: 768px) { .legend { transform: scale(0.6); transform-origin: bottom left; } }
@media (max-width: 768px) {
  .leaflet-control-layers {
    font-size: 10px;
    padding: 2px 4px;
  }
  .leaflet-control-layers-overlays label {
    font-size: 10px;
    line-height: 1.1em;
  }
  .leaflet-control-layers-overlays input[type="checkbox"] {
    transform: scale(0.8);
    margin-top: 1px;
  }
  .leaflet-control-layers-label {
    font-size: 10px;
  }
}
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-gesture-handling"></script>
<script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>

<script>
const MIN_START_ZOOM = 11;
const map = L.map("map", { minZoom: 5, maxZoom: 20, gestureHandling: true, zoomSnap: 1, zoomDelta: 1 }).setView([-5.5, 105.3], 6);

// Basemaps
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap contributors', maxZoom: 19, noWrap: true }).addTo(map);
const satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Tiles &copy; Esri â€” Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community", noWrap: true });
const baseMaps = { "OSM Standar": osm, "Citra Satelit (Esri)": satellite };

// Layer Groups
const aoiGroup = L.layerGroup().addTo(map);
const kebunGroup = L.layerGroup().addTo(map);

// === Risiko dipisah per kategori ===
const risikoRendahGroup = L.layerGroup();
const risikoTinggiGroup = L.layerGroup();
const risikoInfoGroup  = L.layerGroup();

const gfc2020Group = L.layerGroup();
const jrcTMFGroup = L.layerGroup();
const gladGroup = L.layerGroup();
const gladTreeGroup = L.layerGroup();
const alertGroup = L.layerGroup();
const kopiGroup = L.layerGroup();
const simontiniGroup = L.layerGroup();
const wdpaGroup = L.layerGroup();

// Raster layers
const gfc2020Layer = L.tileLayer.wms("https://ies-ows.jrc.ec.europa.eu/iforce/gfc2020/wms.py?", { layers: "gfc2020_v2", format: "image/png", transparent: true, opacity: 0.6 });
gfc2020Group.addLayer(gfc2020Layer);

const gladLayer = L.tileLayer("https://api.ellipsis-drive.com/v3/path/510793ad-e545-499a-9903-b40c066cc0ff/raster/timestamp/d8ecf7af-3ac2-4af2-b36f-34445f2c1217/tile/{z}/{x}/{y}?style=eac2ab85-41e1-4cb9-ab21-73b95da52c7d&token=epat_sjKBq4EdmRVDy8a6GwWe8hEYIbSwDlZbAFM3KiySpvt8PxzvYD4YsZUufBvYDqP4", { transparent: true, opacity: 0.6 });
gladGroup.addLayer(gladLayer);

const gladTreeLayer = L.tileLayer("https://api.ellipsis-drive.com/v3/path/651f9a5a-ef4f-42d3-ab88-ce2f6c0328b2/raster/timestamp/8fc63ec4-6d3d-4ec0-981f-f1b9a89d8228/tile/{z}/{x}/{y}?style=31775b24-2f6f-4036-8031-10233f259c65&token=epat_TK2IUqud6S7iVucGoU9w9fea8M5O48sMBmUDzVUak5I9juVdt6ztFyl34Z7l1pew", { transparent: true, opacity: 0.6 });
gladTreeGroup.addLayer(gladTreeLayer);

const jrcTMFLayer = L.tileLayer("https://api.ellipsis-drive.com/v3/path/5f99cd31-7885-4ae2-8a76-547a43ca558a/raster/timestamp/2c608ad5-73a2-4af2-b36f-34445f2c1217/tile/{z}/{x}/{y}?style=77325c09-be36-4726-a1c4-91471d68d77f&token=epat_KJRJ1jgS47R4FdAVoaYHoAGg5icDFEtlXMzMJyxxWYGBPTaNrTB8rcDESnqL4S85", { transparent: true, opacity: 0.6 });
jrcTMFGroup.addLayer(jrcTMFLayer);

const alertLayer = L.tileLayer("https://api.ellipsis-drive.com/v3/path/ca08dc6e-198e-41c8-9e3d-a6e7e4abbbce/raster/timestamp/94aabaa2-2b8d-49a6-a76e-e4a2ffd62ce6/tile/{z}/{x}/{y}?style=8656078b-77ed-438e-ad42-d531129929a3&token=epat_jPYUO87B0TBzjHZLxG1xfXSobv8XWu5jtQObvUCAuitBNRVRCZGiSyM9du2hnnTV", { transparent: true, opacity: 0.6 });
alertGroup.addLayer(alertLayer);

const kopiLayer = L.tileLayer("https://api.ellipsis-drive.com/v3/path/9d476235-2180-4885-b43e-95fffc99f987/raster/timestamp/31ff9287-5bf2-40e6-b3b5-d0d7c0754ac1/tile/{z}/{x}/{y}?style=12bd57fe-9d85-485c-8b8f-51a57de8977f&token=epat_y87AbkigisVthjOyuJwE19WNCVnrT1jIGz1peyPBKQSW82CKoHaI0jbW8zEL1OWW", { transparent: true, opacity: 0.6 });
kopiGroup.addLayer(kopiLayer);

// Fungsi Kawasan Hutan
const simontiniLayer = L.tileLayer.wms("https://aws.simontini.id/geoserver/wms", {
  layers: "simontini:Forest_estate_adm",
  format: "image/png",
  transparent: true,
  opacity: 0.7
});
simontiniGroup.addLayer(simontiniLayer);

// === WDPA pakai Esri FeatureLayer ===
const wdpaLayer = L.esri.featureLayer({
  url: "https://services5.arcgis.com/Mj0hjvkNtV7NRhA7/arcgis/rest/services/WDPA_v0/FeatureServer/1",
  style: { color: "darkred", weight: 1, fillColor: "darkred", fillOpacity: 0.2 }
});
wdpaGroup.addLayer(wdpaLayer);

// Overlay Layers
const overlayLayers = {
  "Area of Interest": aoiGroup,
  "Kebun Pemasok": kebunGroup,
  "Tutupan Pohon >10% (UMD GLAD 2024 v1.12)": gladTreeGroup,
  "Tutupan Hutan Global (GFC 2020 v2 EU JRC)": gfc2020Group,
  "Kehilangan Tutupan Pohon (UMD GLAD 2024 v1.12)": gladGroup,
  "Deforestasi (TMF 2024 EU JRC)": jrcTMFGroup,
  "Peringatan Gangguan Hutan (GFW 2025)": alertGroup,
  "Perkebunan Kopi (Fardinatri, et al)": kopiGroup,
  "Fungsi Kawasan Hutan (KLHK)": simontiniGroup,
  "Protected Areas (WDPA)": wdpaGroup,
  // === Penilaian Risiko (dipisah) ===
  "Risiko Rendah": risikoRendahGroup,
  "Risiko Tinggi": risikoTinggiGroup,
  "Risiko Butuh Info Lanjutan": risikoInfoGroup
};

const layerControl = L.control.layers(baseMaps, overlayLayers, { collapsed: true }).addTo(map);

// Separator dan pengelompokan label
function ensureSeparators() {
  const control = document.querySelector('.leaflet-control-layers-overlays');
  if (!control) return;

  // Lapisan Utama
  if (!control.querySelector('.lapisan-utama')) {
    const gladTreeLabel = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Tutupan Pohon >10%'));
    if (gladTreeLabel) {
      gladTreeLabel.insertAdjacentHTML('beforebegin',
        "<hr class='layer-separator'><div class='leaflet-control-layers-label lapisan-utama'>Lapisan Utama</div>");
    }
  }

  // Lapisan Pendukung
  if (!control.querySelector('.lapisan-pendukung')) {
    const kopiLabel = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Perkebunan Kopi'));
    if (kopiLabel) {
      kopiLabel.insertAdjacentHTML('beforebegin',
        "<hr class='layer-separator'><div class='leaflet-control-layers-label lapisan-pendukung'>Lapisan Pendukung</div>");
    }
  }

  // Penilaian Risiko (label & garis setelah WDPA)
  if (!control.querySelector('.lapisan-risiko')) {
    const wdpaLabel = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Protected Areas (WDPA)'));
    if (wdpaLabel) {
      wdpaLabel.insertAdjacentHTML('afterend',
        "<hr class='layer-separator'><div class='leaflet-control-layers-label lapisan-risiko'>Penilaian Risiko</div>");
    }
  }

  // Urutkan Risiko: Rendah -> Tinggi -> Info
  const target = control.querySelector('.lapisan-risiko');
  if (target) {
    const risikoRendah = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Risiko Rendah'));
    const risikoTinggi = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Risiko Tinggi'));
    const risikoInfo = Array.from(control.querySelectorAll('label'))
      .find(l => l.textContent.includes('Risiko Butuh Info Lanjutan'));

    // keluarkan lalu sisipkan ulang terbalik -> hasil akhir: Rendah, Tinggi, Info
    [risikoInfo, risikoTinggi, risikoRendah].forEach(lbl => {
      if (lbl) { lbl.remove(); target.insertAdjacentElement('afterend', lbl); }
    });
  }
}

map.whenReady(ensureSeparators);
map.on('layeradd', ensureSeparators);

// Legend
const legend = L.control({ position: "bottomleft" });
legend.onAdd = () => {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <div class="legend-header">
      <span class="legend-title">Keterangan</span>
      <span class="legend-toggle">[-]</span>
    </div>
    <div class="legend-content"></div>
  `;
  div.querySelector(".legend-header").onclick = () => {
    div.classList.toggle("collapsed");
    const toggleBtn = div.querySelector(".legend-toggle");
    toggleBtn.textContent = div.classList.contains("collapsed") ? "[+]" : "[-]";
  };
  div.style.display = "none";
  return div;
};
legend.addTo(map);

function updateLegend() {
  const activeLayers = [];

  if (map.hasLayer(aoiGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: red; opacity:0.2;"></div><div class="legend-text">Area of Interest</div></div>');
  if (map.hasLayer(kebunGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: blue; opacity:0.6;"></div><div class="legend-text">Kebun Pemasok</div></div>');
  if (map.hasLayer(gladTreeGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: darkgreen; opacity:0.6;"></div><div class="legend-text">Tutupan Pohon >10%</div></div>');
  if (map.hasLayer(gfc2020Group)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: green; opacity:0.6;"></div><div class="legend-text">Tutupan Hutan Global</div></div>');
  if (map.hasLayer(kopiGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: #6F4E37; opacity:0.6;"></div><div class="legend-text">Perkebunan Kopi Tanggamus</div></div>');

  if (map.hasLayer(jrcTMFGroup) || map.hasLayer(gladGroup)) {
    let subtitle = "Deforestasi/Kehilangan Tutupan Pohon";
    if (map.hasLayer(jrcTMFGroup) && !map.hasLayer(gladGroup)) subtitle = "Deforestasi (TMF)";
    else if (!map.hasLayer(jrcTMFGroup) && map.hasLayer(gladGroup)) subtitle = "Kehilangan Tutupan Pohon (GLAD)";

    activeLayers.push(`
      <div class="legend-item" style="flex-direction: column; align-items: flex-start;">
        <div class="legend-subtitle">${subtitle}</div>
        <div class="legend-item"><div class="legend-color" style="background:#AA0000;"></div><div class="legend-text">2024</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FF0000;"></div><div class="legend-text">2023</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FF5353;"></div><div class="legend-text">2022</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFA5A5;"></div><div class="legend-text">2021</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFCCCC;"></div><div class="legend-text">â‰¤2020</div></div>
      </div>
    `);
  }

  if (map.hasLayer(alertGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: black; opacity:1;"></div><div class="legend-text">Peringatan Gangguan Hutan (GFW)</div></div>');

  if (map.hasLayer(simontiniGroup)) {
    activeLayers.push(`
      <div class="legend-item" style="flex-direction: column; align-items: flex-start;">
        <div class="legend-subtitle">Fungsi Kawasan Hutan</div>
        <div class="legend-item"><div class="legend-color" style="background:#ADA3FF; opacity:0.7"></div><div class="legend-text">Kawasan Konservasi</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#4CE600; opacity:0.7"></div><div class="legend-text">Hutan Lindung</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFFF73; opacity:0.7"></div><div class="legend-text">Hutan Produksi</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#A3FF73; opacity:0.7"></div><div class="legend-text">Hutan Produksi Terbatas</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFFFFF; opacity:0.7"></div><div class="legend-text">Areal Penggunaan Lain</div></div>
      </div>
    `);
  }

  if (map.hasLayer(wdpaGroup)) activeLayers.push('<div class="legend-item"><div class="legend-color" style="background: darkred; opacity:0.4;"></div><div class="legend-text">Protected Areas (WDPA)</div></div>');

  // Penilaian Risiko (dinamis per kategori aktif)
  if (map.hasLayer(risikoRendahGroup) || map.hasLayer(risikoTinggiGroup) || map.hasLayer(risikoInfoGroup)) {
    let risikoHTML = `<div class="legend-item" style="flex-direction: column; align-items: flex-start;">
        <div class="legend-subtitle">Penilaian Risiko</div>`;
    if (map.hasLayer(risikoRendahGroup)) {
      risikoHTML += `<div class="legend-item"><div class="legend-color circle" style="background:#007bff;"></div><div class="legend-text">Rendah</div></div>`;
    }
    if (map.hasLayer(risikoTinggiGroup)) {
      risikoHTML += `<div class="legend-item"><div class="legend-color circle" style="background:#dc3545;"></div><div class="legend-text">Tinggi</div></div>`;
    }
    if (map.hasLayer(risikoInfoGroup)) {
      risikoHTML += `<div class="legend-item"><div class="legend-color circle" style="background:grey;"></div><div class="legend-text">Butuh Informasi Lanjutan</div></div>`;
    }
    risikoHTML += `</div>`;
    activeLayers.push(risikoHTML);
  }

  const div = document.querySelector(".legend");
  if (!div) return;
  const content = div.querySelector(".legend-content");
  if (activeLayers.length > 0) {
    content.innerHTML = activeLayers.join("");
    div.style.display = "block";
  } else {
    div.style.display = "none";
  }
}

// AOI Layer
fetch("https://raw.githubusercontent.com/RUMAH-PETAni/Map_Animasi/main/AOI.geojson").then(res => res.json()).then(data => {
  const layer = L.geoJSON(data, { color: "red", weight: 2, fillOpacity: 0.2 });
  aoiGroup.clearLayers().addLayer(layer);
  map.fitBounds(layer.getBounds(), { padding: [24,24], maxZoom: MIN_START_ZOOM });
  map.setMaxBounds(layer.getBounds());
  updateLegend();
});

// Kebun Pemasok
fetch("https://raw.githubusercontent.com/RUMAH-PETAni/ekspor_am/main/Geodata_Valid.geojson").then(res => res.json()).then(data => {
  const layer = L.geoJSON(data, {
    color: "blue",
    weight: 2,
    fillOpacity: 0.4,
    onEachFeature: function (feature, lyr) {
      const p = feature.properties || {};
      const uid = p.UID_KEBUN ?? "-";
      const luas = Number(p.LUAS_HA ?? 0);
      lyr.bindPopup(`<b>UID Kebun:</b> ${uid}<br/><b>Luas (ha):</b> ${luas.toFixed(2)}`);
    }
  });
  kebunGroup.clearLayers().addLayer(layer);
  updateLegend();
});

// Data Risiko (split per kategori)
function risikoStyle(risiko) {
  if (!risiko) return { radius: 7, fillColor: "#007bff", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.9 };
  const r = risiko.toString().trim().toLowerCase();
  let color = "#007bff"; // Rendah (default)
  if (r === "tinggi" || r === "high") color = "#dc3545";
  else if (r === "butuh informasi lanjutan" || r === "info") color = "grey";
  return { radius: 7, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.9 };
}

fetch("https://raw.githubusercontent.com/RUMAH-PETAni/ekspor_am/main/Geodata_Risk.geojson")
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, risikoStyle(feature.properties.RISIKO));
      },
      onEachFeature: function (feature, lyr) {
        const r = (feature.properties?.RISIKO || "").toLowerCase();
        lyr.bindPopup(`<b>Penilaian Risiko:</b> ${feature.properties?.RISIKO ?? "-"}`);
        if (r.includes("rendah") || r === "low") {
          risikoRendahGroup.addLayer(lyr);
        } else if (r.includes("tinggi") || r === "high") {
          risikoTinggiGroup.addLayer(lyr);
        } else {
          risikoInfoGroup.addLayer(lyr);
        }
      }
    });
    updateLegend();
  });

// Kendali legend saat overlay berubah
map.on("overlayadd", updateLegend);
map.on("overlayremove", updateLegend);

// Inisialisasi legend
updateLegend();
</script>
</body>
</html>
